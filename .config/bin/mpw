#!/bin/bash

# mpw

# Copyright (C) 2016-2017 Aleksey Rybalkin

# This file is part of unix-home.

# unix-home is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

# unix-home is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with unix-home.  If not, see <http://www.gnu.org/licenses/>.

# dependencies: mpv, socat

MUSICA=/home/musica
SOCKET=/run/mpv-${USER}.socket
PLAYLIST=/tmp/mpv-${USER}-playlist.txt

echo '{ "command": ["get_property", "volume"] }' | socat - ${SOCKET} 2>&1 | grep success >/dev/null 2>&1 || {
    mpv --input-ipc-server=${SOCKET} --idle=yes --loop=inf >/dev/null 2>&1 &
    sleep 0.1
}

if [ "${1}" == "pause" ]; then
    echo '{ "command": ["set_property", "pause", true] }' | socat - ${SOCKET}
    exit 0
fi

if [ "${1}" == "play" ]; then
    echo '{ "command": ["set_property", "pause", false] }' | socat - ${SOCKET}
    exit 0
fi

if [ "${1}" == "next" ]; then
    echo '{ "command": ["playlist-next"] }' | socat - ${SOCKET}
    exit 0
fi

if [ "${1}" == "prev" ]; then
    echo '{ "command": ["playlist-prev"] }' | socat - ${SOCKET}
    exit 0
fi

if [ "${1}" == "ls" ]; then
    F=`echo '{ "command": ["get_property", "filename"] }' | socat - ${SOCKET} | sed 's/{"data":"//g' | sed 's/","error":"success"}//g'`
    cat ${PLAYLIST} | grep --color=always -E "${F}|$" | less
    exit 0
fi

if [ "${1}" == "stop" ]; then
    echo '{ "command": ["stop"] }' | socat - ${SOCKET}
    exit 0
fi

if [ "${1}" == "quit" ]; then
    echo '{ "command": ["quit"] }' | socat - ${SOCKET}
    exit 0
fi

find ${MUSICA} -type f | grep -i "${1}" | sort -R > ${PLAYLIST}
echo "{ \"command\": [\"loadlist\", \"${PLAYLIST}\"] }" | socat - ${SOCKET}
