#!/bin/sh
if [ -z "$1" ]; then
  echo " usage:"
  echo "   shelf pull"
  echo "   shelf push"
  exit 0
fi

if [ "$1" = "pull" ]; then
  CHANGES=`rsync --dry-run -i -a --delete ~/.shelf aleksey@rybalkin.org:~`
  if [ -z "$CHANGES" ]; then
    rsync -av --delete aleksey@rybalkin.org:~/.shelf ~
  else
    if [ "$2" = "--force" ]; then
      echo " you have local changes, but specified --force flag, so pulling anyway"
      rsync -av --delete aleksey@rybalkin.org:~/.shelf ~
    else
      echo " you have local changes, pull aborted"
      echo " list of changes:"
      rsync --dry-run -i -a --delete ~/.shelf aleksey@rybalkin.org:~
    fi
  fi
  exit 0
fi
if [ "$1" = "push" ]; then
  REMOTE_VERSION=`ssh aleksey@rybalkin.org "cat ~/.shelf/.version"`
  LOCAL_VERSION=`cat ~/.shelf/.version`
  if [ "$LOCAL_VERSION" = "$REMOTE_VERSION" ]; then
    let NEW_VERSION=$LOCAL_VERSION+1
    echo "pushing new version $NEW_VERSION"
    echo $NEW_VERSION > ~/.shelf/.version
    rsync -av --delete ~/.shelf aleksey@rybalkin.org:~
  else
    echo "your local version is out of sync with remote, may be shelf pull first?"
    echo "remote: $REMOTE_VERSION, local: $LOCAL_VERSION"
  fi
  exit 0
fi

echo "invalid parameter: $1 (should be pull or push)"
