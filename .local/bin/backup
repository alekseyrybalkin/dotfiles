#!/bin/bash

if [ "${1}" == "heaven" ]; then
  if [ `whoami` != "root" ]; then
    echo "need to be root for this"
    exit 1
  fi
  if [ `hostname` != "rybalkin" ]; then
    echo "run this only in heaven"
    exit 1
  fi
  HEAVEN_BACKUP_LIST="
    /.git
    /root
    /home/vmailer
    /home/committer
    /home/aleksey/.local/archive
    /home/aleksey/projects
    /etc
    /git
    /srv
    /var/lib/dovecot
    /var/lib/ejabberd
    /var/lib/mysql
    /var/lib/nginx
    /var/lib/postfix
    /var/lib/squirrelmail"

  NOW=`date +%s`
  tmpdir=/tmp/backup
  name="rybalkin.org-backup-${NOW}"
  ext=".tar.gz"
  echo " *** creating backup for rybalkin.org..."
  rm -rf ${tmpdir}
  mkdir -p ${tmpdir}
  chmod 700 ${tmpdir}
  cd ${tmpdir}
  mkdir ${name}
  for i in ${HEAVEN_BACKUP_LIST}; do
    j=`echo ${i} | sed 's/\//_/g'`
    tar cfa ${j}${ext} -C `dirname ${i}` `basename ${i}`
    mv ${j}${ext} ./${name}/
  done
  tar -cpavf ${name}${ext} ./${name}

  chown aleksey:aleksey ${name}${ext}
  chmod 600 ${name}${ext}
  mv ${name}${ext} /tmp/

  echo "${name}${ext}" > backup-take

  chown aleksey:aleksey backup-take
  chmod 600 backup-take
  mv backup-take /tmp/

  rm -rf ${tmpdir}
  echo " *** done creating backup for rybalkin.org"
  exit 0
fi

if [ `whoami` != "rybalkin" ]; then
  echo "need to be rybalkin for this"
  exit 1
fi
if [ `hostname` != "ritchie" ]; then
  echo "run this only on ritchie"
  exit 1
fi

if [ -z "`mount | grep seagate`" ]; then
  if [ "${1}" != "--no-seagate" ]; then
    echo "no seagate mounted, will not proceed (use --no-seagate to override)"
    exit 1
  fi
fi

ssh ${HEAVEN} "sudo git --git-dir=/root/.git --work-tree=/root pull; sudo /root/.local/bin/backup heaven"
file=`ssh ${HEAVEN} "cat /tmp/backup-take"`
echo " *** downloading rybalkin.org backup to ritchie..."
scp ${HEAVEN}:/tmp/${file} /var/backups/
ssh ${HEAVEN} "rm /tmp/${file} /tmp/backup-take"
echo " *** done downloading rybalkin.org backup to ritchie"

echo " *** creating backup for ritchie..."
NOW=`date +%s`
tmpdir=/tmp/backup-`uuidgen`
name="`hostname`-backup-${NOW}"
ext=".tar.gz"
mkdir -p ${tmpdir}
cd ${tmpdir}
mkdir ${name}

cp -av ~/.ssh ./${name}
cp -av ~/.config/gnupg ./${name}
cp -av ~/.procmailrc ./${name}
cp -av ~/.fetchmailrc ./${name}
cp -av ~/.config/mutt ./${name}
cp -av ~/.config/hh-vpn ./${name}
cp -av ~arwen/.wine.baldurs-gate-2/drive_c/goggames/baldurs-gate-2/save ./${name}/bg2-save
cp -av ~/projects/pbm ./${name}

tar -cpavf ${name}${ext} ./${name}
gpg -c --passphrase-fd 3 3<~/.local/secrets/encryptpass ${name}${ext}
echo " *** done creating backup for ritchie"
echo " *** uploading ritchie backup to rybalkin.org..."
scp ${name}${ext}.gpg ${HEAVEN}:~/.local/backup/
cp ${name}${ext}.gpg /var/backups/
cd ~
rm -rf ${tmpdir}
echo $NOW > ~/.config/last_backup_timestamp
echo " *** done uploading ritchie backup to rybalkin.org"

if [ "${1}" != "--no-seagate" ]; then
  echo " *** copying backups to seagate..."
  cp /var/backups/${file} /mnt/seagate/backups/
  cp /var/backups/${name}${ext}.gpg /mnt/seagate/backups/
  echo " *** done copying backups to seagate"
fi
